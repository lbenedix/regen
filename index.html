<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Precipitation Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --text-color: #333;
            --card-bg: #fff;
            --card-shadow: rgba(0, 0, 0, 0.1);
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --border-color: #ddd;
            --input-bg: #fff;
            --input-text: #333;
            --success-color: #28a745;
            --error-color: #dc3545;
            --container-max-width: 1000px;
            --stat-highlight-color: #007bff;
        }
        html {
            overscroll-behavior-y: contain;
        }
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2d2d2d;
            --card-shadow: rgba(0, 0, 0, 0.3);
            --button-bg: #0d6efd;
            --button-hover: #0b5ed7;
            --border-color: #404040;
            --input-bg: #404040;
            --input-text: #e0e0e0;
            --stat-highlight-color: #4dabf7;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: touch;
        }
        h1 {
            text-align: center;
            color: var(--text-color);
        }
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--button-bg);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 2px 8px var(--card-shadow);
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 1000;
        }
        .theme-toggle:hover {
            background: var(--button-hover);
            transform: scale(1.1);
        }
        .select-container {
            margin: 20px auto;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .date-selectors {
            display: none;
            margin: 20px auto;
            text-align: center;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        select {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            width: 200px;
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        button {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: var(--button-hover);
        }
        #stationSelect {
            width: 350px;
            min-width: 350px;
            background-color: var(--input-bg);
            color: var(--input-text);
        }
        .chart-container {
            max-width: var(--container-max-width);
            width: 100%;
            height: 400px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--card-shadow);
            position: relative;
            box-sizing: border-box;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        canvas {
            display: block;
            box-sizing: border-box;
        }
        .stats-container {
            max-width: var(--container-max-width);
            width: 100%;
            margin: 20px auto;
            display: none;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--card-shadow);
            padding: 20px;
            box-sizing: border-box;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .stats-container.visible {
            display: block;
        }
        .stats-container h2 {
            margin: 0 0 15px 0;
            color: var(--text-color);
            font-size: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .stat-item {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .stat-label {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--stat-highlight-color);
            margin-top: 5px;
        }
        .station-info {
            max-width: var(--container-max-width);
            width: 100%;
            margin: 20px auto;
            display: none;
            gap: 20px;
        }
        .station-info.visible {
            display: flex;
        }
        .map-container {
            width: 300px;
            height: 200px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--card-shadow);
            overflow: hidden;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .station-details {
            flex: 1;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--card-shadow);
            padding: 20px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .station-details h3 {
            margin: 0 0 10px 0;
            color: var(--text-color);
        }
        .station-details p {
            margin: 5px 0;
            color: var(--text-color);
        }
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
        }
        .toast {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px var(--card-shadow);
            display: flex;
            align-items: center;
            min-width: 250px;
            animation: slideIn 0.3s ease forwards;
            opacity: 0;
            transform: translateX(100%);
        }
        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .toast.success {
            border-left: 4px solid var(--success-color);
        }
        .toast.error {
            border-left: 4px solid var(--error-color);
        }
        .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--button-bg);
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .station-info {
                flex-direction: column;
            }
            .map-container {
                width: 100%;
                height: 250px;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }
    </style>
</head>
<body>
<button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
    ðŸŒ™
</button>
<h1>Monthly Precipitation Charts</h1>
<div class="select-container">
    <select id="stationSelect" onchange="handleStationChange()">
        <option value="">Select Station</option>
    </select>
</div>
<div class="date-selectors" id="dateSelectors">
    <button onclick="changeMonth(-1)">&larr;</button>
    <select id="yearSelect" onchange="loadStationData()">
        <option value="">Select Year</option>
    </select>
    <select id="monthSelect" onchange="loadStationData()">
        <option value="">Select Month</option>
    </select>
    <button onclick="changeMonth(1)">&rarr;</button>
</div>
<div class="loading-spinner" id="loadingSpinner"></div>
<div id="charts"></div>
<div class="stats-container" id="statsContainer">
    <h2>Monthly Statistics</h2>
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-label">Total Precipitation</div>
            <div class="stat-value" id="totalPrecipitation">-</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Rainy Days</div>
            <div class="stat-value" id="rainyDays">-</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Daily Average</div>
            <div class="stat-value" id="dailyAverage">-</div>
        </div>
    </div>
</div>
<div class="station-info" id="stationInfo">
    <div class="map-container">
        <div id="map" style="width: 100%; height: 100%;"></div>
    </div>
    <div class="station-details">
        <h3 id="stationName">Station Name</h3>
        <p><strong>ID:</strong> <span id="stationId">-</span></p>
        <p><strong>Elevation:</strong> <span id="stationElevation">-</span> m</p>
        <p><strong>Federal State:</strong> <span id="stationState">-</span></p>
        <p><strong>Coordinates:</strong> <span id="stationCoords">-</span></p>
    </div>
</div>
<div class="toast-container" id="toastContainer"></div>

<script>
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        showToast('Chart.js failed to load. Please check your internet connection or the CDN link.', 'error');
    }

    // Constants
    const APP_STATE = {
        STATIONS: {},
        STATION_FEATURES: {},
        DATA_CACHE: {},
        map: null,
        currentMarker: null,
        currentChart: null,
        currentStationData: null,
        mapInitialized: false
    };

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        loadTheme();
        initializeApp();
    });

    // Initialize app components
    function initializeApp() {
        moment.locale('de');
        preventPullToRefresh();
        populateYearDropdown();
        populateMonthDropdown();
        loadStations();

        // Set default station after loading
        setTimeout(() => {
            const stationSelect = document.getElementById('stationSelect');
            if (stationSelect.options.length > 1) {
                stationSelect.value = "19897";
                handleStationChange();
            }
        }, 500);
    }

    // Prevent pull-to-refresh on mobile devices
    function preventPullToRefresh() {
        let startY = 0;
        let isPreventingPullToRefresh = false;

        document.addEventListener('touchstart', function (e) {
            startY = e.touches[0].pageY;
            isPreventingPullToRefresh = window.pageYOffset === 0;
        }, {passive: false});

        document.addEventListener('touchmove', function (e) {
            const currentY = e.touches[0].pageY;
            const isScrollingDown = currentY > startY;
            if (isPreventingPullToRefresh && isScrollingDown) {
                e.preventDefault();
            }
        }, {passive: false});

        document.body.style.overscrollBehavior = 'contain';
        document.documentElement.style.overscrollBehavior = 'contain';
    }

    // Theme management
    function toggleTheme() {
        const html = document.documentElement;
        const toggleButton = document.querySelector('.theme-toggle');
        const currentTheme = html.getAttribute('data-theme');

        if (currentTheme === 'dark') {
            html.removeAttribute('data-theme');
            toggleButton.textContent = 'ðŸŒ™';
            localStorage.setItem('theme', 'light');
        } else {
            html.setAttribute('data-theme', 'dark');
            toggleButton.textContent = 'â˜€ï¸';
            localStorage.setItem('theme', 'dark');
        }

        // Refresh chart if it exists to update colors
        if (APP_STATE.currentChart) {
            updateChartColors();
        }
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        const html = document.documentElement;
        const toggleButton = document.querySelector('.theme-toggle');

        if (savedTheme === 'dark') {
            html.setAttribute('data-theme', 'dark');
            toggleButton.textContent = 'â˜€ï¸';
        } else {
            html.removeAttribute('data-theme');
            toggleButton.textContent = 'ðŸŒ™';
        }
    }

    // Station management
    function loadStations() {
        fetch('stations.geojson')
            .then(response => {
                if (!response.ok) throw new Error('Failed to load stations data');
                return response.json();
            })
            .then(geojsonData => {
                const desiredStationIds = new Set([400, 403, 420, 426, 433, 17444, 17445, 17446, 17447, 17448, 17449, 17450,
                    17451, 17452, 17453, 17454, 17455, 17456, 17457, 17458, 17459, 17460, 17461,
                    17462, 17463, 17464, 17465, 17466, 17467, 17468, 17469, 17470, 17471, 17472,
                    17473, 17474, 17475, 17476, 17477, 17478, 17479, 17480, 17481, 17482, 17483,
                    17484, 17485, 17486, 17487, 17488, 17489, 17490, 17491, 19897, 19898]);

                geojsonData.features.forEach(feature => {
                    const stationId = parseInt(feature.properties.station_id);
                    if (desiredStationIds.has(stationId)) {
                        APP_STATE.STATIONS[stationId] = feature.properties.station_name;
                        APP_STATE.STATION_FEATURES[stationId] = feature;
                    }
                });

                populateStationDropdown();
                showToast('Stations loaded successfully', 'success');
            })
            .catch(error => {
                console.error('Error loading stations:', error);
                showToast('Error loading station data', 'error');
            });
    }

    function populateStationDropdown() {
        const stationSelect = document.getElementById('stationSelect');

        Object.entries(APP_STATE.STATIONS)
            .sort((a, b) => a[1].localeCompare(b[1]))
            .forEach(([id, name]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                stationSelect.appendChild(option);
            });
    }

    function populateYearDropdown() {
        const yearSelect = document.getElementById('yearSelect');
        for (let year = 2020; year <= 2025; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }
    }

    function populateMonthDropdown() {
        const monthSelect = document.getElementById('monthSelect');
        const months = moment.months();

        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index + 1; // 1-12 for January-December
            option.textContent = month;
            monthSelect.appendChild(option);
        });
    }

    // Map management
    function initializeMap() {
        // Only initialize the map once
        if (APP_STATE.mapInitialized) {
            return;
        }

        // Check if the map container is available
        const mapContainer = document.getElementById('map');
        if (!mapContainer) {
            console.error('Map container not found');
            return;
        }

        // Initialize map centered on Germany without zoom controls
        APP_STATE.map = L.map('map', {
            zoomControl: false
        }).setView([51.1657, 10.4515], 6);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(APP_STATE.map);

        APP_STATE.mapInitialized = true;

        // Force a resize after a short delay to ensure proper rendering
        setTimeout(() => {
            if (APP_STATE.map) {
                APP_STATE.map.invalidateSize();
            }
        }, 100);
    }

    function updateStationInfo(stationId) {
        const feature = APP_STATE.STATION_FEATURES[stationId];
        if (!feature) return;

        const props = feature.properties;
        const coords = feature.geometry.coordinates;

        // Update station details
        document.getElementById('stationName').textContent = props.station_name;
        document.getElementById('stationId').textContent = props.station_id;
        document.getElementById('stationElevation').textContent = props.elevation || 'N/A';
        document.getElementById('stationState').textContent = props.federal_state || 'N/A';
        document.getElementById('stationCoords').textContent = `${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`;

        // Initialize map if not already done
        initializeMap();

        // Update map
        if (APP_STATE.map) {
            // Remove previous marker
            if (APP_STATE.currentMarker) {
                APP_STATE.map.removeLayer(APP_STATE.currentMarker);
            }

            // Add new marker
            APP_STATE.currentMarker = L.marker([coords[1], coords[0]])
                .addTo(APP_STATE.map)
                .bindPopup(`<b>${props.station_name}</b><br>ID: ${props.station_id}<br>Elevation: ${props.elevation}m`);

            // Center map on station
            APP_STATE.map.setView([coords[1], coords[0]], 13);
        }

        // Show station info section
        document.getElementById('stationInfo').classList.add('visible');
    }

    // Data management
    function handleStationChange() {
        const stationId = document.getElementById('stationSelect').value;
        const dateSelectors = document.getElementById('dateSelectors');
        const stationInfo = document.getElementById('stationInfo');

        if (stationId) {
            const now = moment();
            document.getElementById('yearSelect').value = now.year();
            document.getElementById('monthSelect').value = now.month() + 1;

            dateSelectors.style.display = 'flex';
            updateStationInfo(stationId);
            loadStationData(stationId);
        } else {
            dateSelectors.style.display = 'none';
            stationInfo.classList.remove('visible');
            document.getElementById('charts').innerHTML = '';
            document.getElementById('statsContainer').classList.remove('visible');
        }
    }

    function changeMonth(direction) {
        const year = parseInt(document.getElementById('yearSelect').value);
        const month = parseInt(document.getElementById('monthSelect').value);

        if (!year || !month) return;

        let newDate = moment(`${year}-${month}-01`, 'YYYY-M-DD').add(direction, 'month');
        document.getElementById('yearSelect').value = newDate.year();
        document.getElementById('monthSelect').value = newDate.month() + 1;

        loadStationData(document.getElementById('stationSelect').value);
    }

    function loadStationData(stationId) {
        const year = document.getElementById('yearSelect').value;
        const month = document.getElementById('monthSelect').value;

        if (!stationId || !year || !month) {
            document.getElementById('charts').innerHTML = '';
            document.getElementById('statsContainer').classList.remove('visible');
            return;
        }

        // Show loading spinner
        document.getElementById('loadingSpinner').style.display = 'block';

        const fileName = `data/rain_data_${stationId.padStart(5, '0')}.json`;
        const cacheKey = `${stationId}-${year}-${month}`;

        // Check if data is already cached
        if (APP_STATE.DATA_CACHE[cacheKey]) {
            processStationData(APP_STATE.DATA_CACHE[cacheKey], APP_STATE.STATIONS[stationId], year, month);
            document.getElementById('loadingSpinner').style.display = 'none';
            return;
        }

        fetch(fileName)
            .then(response => {
                if (!response.ok) {
                    throw new Error('File not found or network error');
                }
                return response.json();
            })
            .then(data => {
                // Cache the data
                APP_STATE.DATA_CACHE[cacheKey] = data;
                processStationData(data, APP_STATE.STATIONS[stationId], year, month);
                document.getElementById('loadingSpinner').style.display = 'none';
            })
            .catch(error => {
                console.error('Error loading data:', error);
                showToast(`Error loading data: ${error.message}`, 'error');
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('charts').innerHTML = '';
                document.getElementById('statsContainer').classList.remove('visible');
            });
    }

    function processStationData(data, stationName, year, month) {
        if (!window.Chart) {
            showToast('Chart.js is not available. Cannot render charts.', 'error');
            return;
        }

        // Destroy previous chart instance if it exists
        if (APP_STATE.currentChart) {
            APP_STATE.currentChart.destroy();
            APP_STATE.currentChart = null;
        }

        // Filter data for the selected year and month
        const monthYear = `${year}-${month.padStart(2, '0')}`;
        const monthData = data
            .filter(entry => moment(entry.date, 'YYYY-MM-DD').format('YYYY-MM') === monthYear)
            .map(entry => ({
                date: moment(entry.date, 'YYYY-MM-DD').toDate(),
                precipitation: entry.precipitation
            }))
            .sort((a, b) => a.date - b.date);

        // Store current station data
        APP_STATE.currentStationData = {
            stationName,
            year,
            month,
            data: monthData
        };

        // Clear previous charts
        const chartsContainer = document.getElementById('charts');
        chartsContainer.innerHTML = '';

        if (monthData.length === 0) {
            chartsContainer.innerHTML = '<p>No data available for this month.</p>';
            document.getElementById('statsContainer').classList.remove('visible');
            return;
        }

        // Calculate statistics
        const precipitationValues = monthData.map(d => d.precipitation);
        const totalPrecipitation = precipitationValues.reduce((sum, val) => sum + val, 0);
        const rainyDays = precipitationValues.filter(val => val > 0).length;
        const dailyAverage = totalPrecipitation / precipitationValues.length;

        // Update statistics display
        document.getElementById('totalPrecipitation').textContent = `${totalPrecipitation.toFixed(1)} mm`;
        document.getElementById('rainyDays').textContent = rainyDays;
        document.getElementById('dailyAverage').textContent = `${dailyAverage.toFixed(1)} mm`;

        // Show statistics container
        document.getElementById('statsContainer').classList.add('visible');
        
        // Create a single bar chart for the selected month
        const container = document.createElement('div');
        container.className = 'chart-container';
        const canvas = document.createElement('canvas');
        container.appendChild(canvas);
        chartsContainer.appendChild(container);
        
        // Get theme colors
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const textColor = isDark ? '#e0e0e0' : '#333';
        const gridColor = isDark ? '#404040' : '#e0e0e0';
        
        APP_STATE.currentChart = new Chart(canvas, {
            type: 'bar',
            data: {
                datasets: [{
                    label: `Precipitation (${stationName})`,
                    data: monthData.map(d => ({
                        x: d.date,
                        y: d.precipitation
                    })),
                    backgroundColor: 'rgba(0, 123, 255, 0.5)',
                    borderColor: '#007bff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 0
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'ddd MMM D'
                            }
                        },
                        title: {
                            display: false,
                            text: 'Date',
                            color: textColor
                        },
                        min: moment(`${year}-${month}-01`, 'YYYY-MM-DD').toDate(),
                        max: moment(`${year}-${month}-01`, 'YYYY-MM-DD').endOf('month').toDate(),
                        ticks: {
                            maxRotation: 90,
                            minRotation: 90,
                            color: textColor
                        },
                        grid: {
                            color: gridColor
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Precipitation (mm)',
                            color: textColor
                        },
                        beginAtZero: true,
                        min: 0,
                        max: 60,
                        ticks: {
                            color: textColor
                        },
                        grid: {
                            color: gridColor
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: `Precipitation for ${stationName} - ${moment(monthYear, 'YYYY-MM').format('MMMM YYYY')}`,
                        color: textColor
                    },
                    legend: {
                        labels: {
                            color: textColor
                        }
                    }
                }
            }
        });
        
        // Force initial resize after a short delay
        setTimeout(() => {
            if (APP_STATE.currentChart) {
                APP_STATE.currentChart.resize();
            }
        }, 100);
    }
    
    // Chart management
    function updateChartColors() {
        if (!APP_STATE.currentChart) return;
        
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const textColor = isDark ? '#e0e0e0' : '#333';
        const gridColor = isDark ? '#404040' : '#e0e0e0';
        
        APP_STATE.currentChart.options.scales.x.ticks.color = textColor;
        APP_STATE.currentChart.options.scales.x.title.color = textColor;
        APP_STATE.currentChart.options.scales.x.grid.color = gridColor;
        APP_STATE.currentChart.options.scales.y.ticks.color = textColor;
        APP_STATE.currentChart.options.scales.y.title.color = textColor;
        APP_STATE.currentChart.options.scales.y.grid.color = gridColor;
        APP_STATE.currentChart.options.plugins.title.color = textColor;
        APP_STATE.currentChart.options.plugins.legend.labels.color = textColor;
        
        APP_STATE.currentChart.update('none');
    }
    
    // Navigation functionality
    function changeStation(direction) {
        const stationSelect = document.getElementById('stationSelect');
        const currentStationId = stationSelect.value;
        
        if (!currentStationId) return;
        
        const options = Array.from(stationSelect.options).slice(1);
        const currentIndex = options.findIndex(option => option.value === currentStationId);
        
        if (currentIndex === -1) return;
        
        let newIndex = currentIndex + direction;
        if (newIndex < 0) {
            newIndex = options.length - 1;
        } else if (newIndex >= options.length) {
            newIndex = 0;
        }
        
        const currentYear = document.getElementById('yearSelect').value;
        const currentMonth = document.getElementById('monthSelect').value;
        
        stationSelect.value = options[newIndex].value;
        updateStationInfo(options[newIndex].value);
        
        if (currentYear && currentMonth) {
            document.getElementById('yearSelect').value = currentYear;
            document.getElementById('monthSelect').value = currentMonth;
        }
        
        loadStationData(stationSelect.value);
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', function (e) {
        const dateSelectors = document.getElementById('dateSelectors');
        if (dateSelectors.style.display !== 'flex') return;
        
        if (e.key === 'ArrowLeft') {
            changeMonth(-1);
            e.preventDefault();
        } else if (e.key === 'ArrowRight') {
            changeMonth(1);
            e.preventDefault();
        } else if (e.key === 'ArrowUp') {
            changeStation(-1);
            e.preventDefault();
        } else if (e.key === 'ArrowDown') {
            changeStation(1);
            e.preventDefault();
        }
    });
    
    // Touch navigation
    let touchStartX = null;
    let touchStartY = null;
    
    document.addEventListener('touchstart', function (e) {
        if (e.touches.length === 1) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }
    });
    
    document.addEventListener('touchend', function (e) {
        if (touchStartX === null || touchStartY === null) return;
        
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const dx = touchEndX - touchStartX;
        const dy = touchEndY - touchStartY;
        
        const dateSelectors = document.getElementById('dateSelectors');
        if (dateSelectors.style.display !== 'flex') return;
        
        if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
            if (dx < 0) {
                changeMonth(1);
            } else {
                changeMonth(-1);
            }
        } else if (Math.abs(dy) > 50 && Math.abs(dy) > Math.abs(dx)) {
            if (dy < 0) {
                changeStation(-1);
            } else {
                changeStation(1);
            }
        }
        
        touchStartX = null;
        touchStartY = null;
    });
    
    // Toast notification system
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        toast.innerHTML = `
            <span>${message}</span>
            <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
        `;
        
        toastContainer.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }
    
    // Window resize handling
    let resizeTimeout = null;
    
    function debounceResize() {
        if (resizeTimeout) {
            clearTimeout(resizeTimeout);
        }
        
        resizeTimeout = setTimeout(() => {
            if (APP_STATE.currentChart) {
                APP_STATE.currentChart.resize();
            }
            if (APP_STATE.map) {
                APP_STATE.map.invalidateSize();
            }
        }, 150);
    }
    
    window.addEventListener('resize', debounceResize);
</script>
</body>
</html>
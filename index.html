<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Precipitation Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .select-container {
            margin: 20px auto;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .date-selectors {
            display: none;
            margin: 20px auto;
            text-align: center;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .date-selectors {
            display: none; /* Hidden until a station is selected */
        }

        select {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            width: 200px;
        }

        button {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        #stationSelect {
            width: 350px;
            min-width: 350px;
        }

        .chart-container {
            max-width: 1000px;
            width: 100%;
            height: 400px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            box-sizing: border-box;
        }

        canvas {
            display: block;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<div class="select-container">
    <select id="stationSelect" onchange="handleStationChange()">
        <option value="">Select Station</option>
    </select>
</div>

<div class="date-selectors" id="dateSelectors">
    <button onclick="changeMonth(-1)">&larr;</button>
    <select id="yearSelect" onchange="loadStationData()">
        <option value="">Select Year</option>
    </select>
    <select id="monthSelect" onchange="loadStationData()">
        <option value="">Select Month</option>
    </select>
    <button onclick="changeMonth(1)">&rarr;</button>
</div>


<div id="charts"></div>

<script>
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        alert('Chart.js failed to load. Please check your internet connection or the CDN link.');
    }
    moment.locale('de');

    const STATIONS = {
        400: "Berlin-Buch",
        403: "Berlin-Dahlem (FU)",
        420: "Berlin-Marzahn",
        426: "Berlin-Schmöckwitz",
        433: "Berlin-Tempelhof",
        17444: "Berlin-Zehlendorf-Düppel",
        17445: "Berlin-Schönow",
        17446: "Berlin-Hubertusbrücke",
        17447: "Berlin-Colonie Alsen",
        17448: "Berlin-Lichtenrade (Lockestr.)",
        17449: "Berlin-Wilmersdorf",
        17450: "Berlin-Grunewald",
        17451: "Berlin-Charlottenburg (Mollwitzstr.)",
        17452: "Berlin-Wedding",
        17453: "Berlin-Haselhorst",
        17454: "Berlin-Hakenfelde",
        17455: "Berlin-Gatow",
        17456: "Berlin-Staaken",
        17457: "Berlin-Reinickendorf",
        17458: "Berlin-Frohnau (Bifröstweg)",
        17459: "Berlin-Heiligensee",
        17460: "Berlin-Neukölln",
        17461: "Berlin-Köllnische Heide",
        17462: "Berlin-Britz",
        17463: "Berlin-Rudow (Stubenrauchstr.)",
        17464: "Berlin-Johannisthal (Winckelmannstr.)",
        17465: "Berlin-Grünau",
        17466: "Berlin-Schmöckwitz/Dahme",
        17467: "Berlin-Köpenick/Spree",
        17468: "Berlin-Friedrichshagen-Hirschgarten",
        17469: "Berlin-Köpenick-Müggelheim",
        17470: "Berlin-Rummelsburg",
        17471: "Berlin-Biesdorf",
        17472: "Berlin-Oberschöneweide",
        17473: "Berlin-Friedrichshain/Spree",
        17474: "Berlin-Pankow-Prenzlauer Berg",
        17475: "Berlin-Gesundbrunnen",
        17476: "Berlin-Marzahn-Bürknersfelde",
        17477: "Berlin-Lichtenberg-Malchow",
        17478: "Berlin-Hohenschönhausen",
        17479: "Berlin-Karow",
        17480: "Berlin-Hessenwinkel",
        17481: "Berlin-Marienfelde (Grillostr.)",
        17482: "Berlin/Biesdorfer Baggersee",
        17483: "Berlin-Mitte/Südpanke",
        17484: "Berlin-Borsigwalde",
        17485: "Berlin-Lichterfelde",
        17486: "Berlin-Wilhelmstadt",
        17487: "Berlin-Kreuzberg",
        17488: "Berlin-Waidmannslust",
        17489: "Berlin-Heinersdorf",
        17490: "Berlin-Pankow-Rosenthal",
        17491: "Berlin-Blankenfelde",
        19897: "Berlin-Friedrichshain-Nord",
        19898: "Berlin-Halensee",
        721: "Schönwölkau-Brinnis"
    };

    // Populate station dropdown, sorted alphabetically by name
    const stationSelect = document.getElementById('stationSelect');
    Object.entries(STATIONS)
        .sort((a, b) => a[1].localeCompare(b[1]))
        .forEach(([id, name]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = name;
            stationSelect.appendChild(option);
        });

    // Populate year dropdown (2020-2025)
    const yearSelect = document.getElementById('yearSelect');
    for (let year = 2020; year <= 2025; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }

    // Populate month dropdown
    const monthSelect = document.getElementById('monthSelect');
    const months = moment.months();
    months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index + 1; // 1-12 for January-December
        option.textContent = month;
        monthSelect.appendChild(option);
    });

    function handleStationChange() {
        const stationId = stationSelect.value;
        const dateSelectors = document.getElementById('dateSelectors');
        if (stationId) {
            // Set current year and month
            const now = moment();
            yearSelect.value = now.year();
            monthSelect.value = now.month() + 1; // moment months are 0-11, select uses 1-12
            dateSelectors.style.display = 'flex';
            loadStationData();
        } else {
            dateSelectors.style.display = 'none';
            document.getElementById('charts').innerHTML = '';
        }
    }

    function changeMonth(direction) {
        const year = parseInt(yearSelect.value);
        const month = parseInt(monthSelect.value);
        if (!year || !month) return;

        let newDate = moment(`${year}-${month}-01`, 'YYYY-M-DD').add(direction, 'month');
        yearSelect.value = newDate.year();
        monthSelect.value = newDate.month() + 1; // moment months are 0-11, dropdown uses 1-12
        loadStationData();
    }

    function loadStationData() {
        const stationId = stationSelect.value;
        const year = yearSelect.value;
        const month = monthSelect.value;

        if (!stationId || !year || !month) {
            document.getElementById('charts').innerHTML = '';
            return;
        }

        const fileName = `data/rain_data_${stationId.padStart(5, '0')}.json`;
        fetch(fileName)
            .then(response => {
                if (!response.ok) {
                    throw new Error('File not found or network error');
                }
                return response.json();
            })
            .then(data => processData(data, STATIONS[stationId], year, month))
            .catch(error => {
                alert('Error loading data: ' + error.message);
                document.getElementById('charts').innerHTML = '';
            });
    }

    function processData(data, stationName, year, month) {
        if (!window.Chart) {
            alert('Chart.js is not available. Cannot render charts.');
            return;
        }

        // Destroy previous chart instance if it exists
        if (currentChart) {
            currentChart.destroy();
            currentChart = null;
        }

        // Filter data for the selected year and month
        const monthYear = `${year}-${month.padStart(2, '0')}`;
        const monthData = data
            .filter(entry => moment(entry.date, 'YYYY-MM-DD').format('YYYY-MM') === monthYear)
            .map(entry => ({
                date: moment(entry.date, 'YYYY-MM-DD').toDate(),
                precipitation: entry.precipitation
            }))
            .sort((a, b) => a.date - b.date);

        // Clear previous charts
        const chartsContainer = document.getElementById('charts');
        chartsContainer.innerHTML = '';

        if (monthData.length === 0) {
            chartsContainer.innerHTML = '<p>No data available for this month.</p>';
            return;
        }

        // Create a single bar chart for the selected month
        const container = document.createElement('div');
        container.className = 'chart-container';
        const canvas = document.createElement('canvas');
        container.appendChild(canvas);
        chartsContainer.appendChild(container);

        currentChart = new Chart(canvas, {
            type: 'bar',
            data: {
                datasets: [{
                    label: `Precipitation (${stationName})`,
                    data: monthData.map(d => ({
                        x: d.date,
                        y: d.precipitation
                    })),
                    backgroundColor: 'rgba(0, 123, 255, 0.5)',
                    borderColor: '#007bff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 0
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'ddd MMM D' // Shows weekday, month, day
                            }
                        },
                        title: {
                            display: false,
                            text: 'Date'
                        },
                        min: moment(`${year}-${month}-01`, 'YYYY-MM-DD').toDate(),
                        max: moment(`${year}-${month}-01`, 'YYYY-MM-DD').endOf('month').toDate(),
                        ticks: {
                            maxRotation: 90,
                            minRotation: 90
                        }

                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Precipitation (mm)'
                        },
                        beginAtZero: true,
                        min: 0,
                        max: 50 // Set your desired max value
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: `Precipitation for ${stationName} - ${moment(monthYear, 'YYYY-MM').format('MMMM YYYY')}`
                    }
                }
            }
        });

        // Force initial resize after a short delay
        setTimeout(() => {
            if (currentChart) {
                currentChart.resize();
            }
        }, 100);
    }

    document.addEventListener('keydown', function (e) {
        // Only trigger if date selectors are visible
        const dateSelectors = document.getElementById('dateSelectors');
        if (dateSelectors.style.display !== 'flex') return;

        if (e.key === 'ArrowLeft') {
            changeMonth(-1);
            e.preventDefault();
        } else if (e.key === 'ArrowRight') {
            changeMonth(1);
            e.preventDefault();
        }
    });

    let currentChart = null;
    let touchStartX = null;
    let touchStartY = null;
    let resizeTimeout = null;

    // Debounced resize function
    function debounceResize() {
        if (resizeTimeout) {
            clearTimeout(resizeTimeout);
        }
        resizeTimeout = setTimeout(() => {
            if (currentChart) {
                currentChart.resize();
            }
        }, 150);
    }

    // Handle window resize to make chart responsive
    window.addEventListener('resize', debounceResize);

    document.addEventListener('touchstart', function (e) {
        if (e.touches.length === 1) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }
    });

    document.addEventListener('touchend', function (e) {
        if (touchStartX === null || touchStartY === null) return;
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const dx = touchEndX - touchStartX;
        const dy = touchEndY - touchStartY;

        // Only trigger if date selectors are visible
        const dateSelectors = document.getElementById('dateSelectors');
        if (dateSelectors.style.display !== 'flex') return;

        // Check for horizontal swipe (ignore vertical movement)
        if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
            if (dx < 0) {
                changeMonth(1); // Swipe left: next month
            } else {
                changeMonth(-1); // Swipe right: previous month
            }
        }
        touchStartX = null;
        touchStartY = null;
    });

    stationSelect.value = "19897";
    handleStationChange();
</script>
</body>
</html>
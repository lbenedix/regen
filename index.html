<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Precipitation Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --text-color: #333;
            --card-bg: #fff;
            --card-shadow: rgba(0, 0, 0, 0.1);
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --border-color: #ddd;
            --input-bg: #fff;
            --input-text: #333;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2d2d2d;
            --card-shadow: rgba(0, 0, 0, 0.3);
            --button-bg: #0d6efd;
            --button-hover: #0b5ed7;
            --border-color: #404040;
            --input-bg: #404040;
            --input-text: #e0e0e0;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        h1 {
            text-align: center;
            color: var(--text-color);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--button-bg);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 2px 8px var(--card-shadow);
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            background: var(--button-hover);
            transform: scale(1.1);
        }

        .select-container {
            margin: 20px auto;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .date-selectors {
            display: none;
            margin: 20px auto;
            text-align: center;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .date-selectors {
            display: none; /* Hidden until a station is selected */
        }

        select {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            width: 200px;
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        button {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: var(--button-hover);
        }

        #stationSelect {
            width: 350px;
            min-width: 350px;
            background-color: var(--input-bg);
            color: var(--input-text);
        }

        .chart-container {
            max-width: 1000px;
            width: 100%;
            height: 400px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--card-shadow);
            position: relative;
            box-sizing: border-box;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        canvas {
            display: block;
            box-sizing: border-box;
        }

        .station-info {
            max-width: 1000px;
            width: 100%;
            margin: 20px auto;
            display: none;
            gap: 20px;
        }

        .station-info.visible {
            display: flex;
        }

        .map-container {
            width: 300px;
            height: 200px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--card-shadow);
            overflow: hidden;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .station-details {
            flex: 1;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--card-shadow);
            padding: 20px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .station-details h3 {
            margin: 0 0 10px 0;
            color: var(--text-color);
        }

        .station-details p {
            margin: 5px 0;
            color: var(--text-color);
        }

        @media (max-width: 768px) {
            .station-info {
                flex-direction: column;
            }
            
            .map-container {
                width: 100%;
                height: 250px;
            }
        }
    </style>
</head>
<body>

<button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
    ðŸŒ™
</button>

<div class="select-container">
    <select id="stationSelect" onchange="handleStationChange()">
        <option value="">Select Station</option>
    </select>
</div>

<div class="date-selectors" id="dateSelectors">
    <button onclick="changeMonth(-1)">&larr;</button>
    <select id="yearSelect" onchange="loadStationData()">
        <option value="">Select Year</option>
    </select>
    <select id="monthSelect" onchange="loadStationData()">
        <option value="">Select Month</option>
    </select>
    <button onclick="changeMonth(1)">&rarr;</button>
</div>

<div id="charts"></div>

<div class="station-info" id="stationInfo">
    <div class="map-container">
        <div id="map" style="width: 100%; height: 100%;"></div>
    </div>
    <div class="station-details">
        <h3 id="stationName">Station Name</h3>
        <p><strong>ID:</strong> <span id="stationId">-</span></p>
        <p><strong>Elevation:</strong> <span id="stationElevation">-</span> m</p>
        <p><strong>Federal State:</strong> <span id="stationState">-</span></p>
        <p><strong>Coordinates:</strong> <span id="stationCoords">-</span></p>
    </div>
</div>

<script>
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        alert('Chart.js failed to load. Please check your internet connection or the CDN link.');
    }
    moment.locale('de');

    let STATIONS = {};
    let STATION_FEATURES = {};
    let map = null;
    let currentMarker = null;

    // Dark mode functionality
    function toggleTheme() {
        const html = document.documentElement;
        const toggleButton = document.querySelector('.theme-toggle');
        const currentTheme = html.getAttribute('data-theme');
        
        if (currentTheme === 'dark') {
            html.removeAttribute('data-theme');
            toggleButton.textContent = 'ðŸŒ™';
            localStorage.setItem('theme', 'light');
        } else {
            html.setAttribute('data-theme', 'dark');
            toggleButton.textContent = 'â˜€ï¸';
            localStorage.setItem('theme', 'dark');
        }
        
        // Refresh chart if it exists to update colors
        if (currentChart) {
            updateChartColors();
        }
    }

    // Load saved theme preference
    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        const html = document.documentElement;
        const toggleButton = document.querySelector('.theme-toggle');
        
        if (savedTheme === 'dark') {
            html.setAttribute('data-theme', 'dark');
            toggleButton.textContent = 'â˜€ï¸';
        } else {
            html.removeAttribute('data-theme');
            toggleButton.textContent = 'ðŸŒ™';
        }
    }

    // Update chart colors based on theme
    function updateChartColors() {
        if (!currentChart) return;
        
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const textColor = isDark ? '#e0e0e0' : '#333';
        const gridColor = isDark ? '#404040' : '#e0e0e0';
        
        currentChart.options.scales.x.ticks.color = textColor;
        currentChart.options.scales.x.title.color = textColor;
        currentChart.options.scales.x.grid.color = gridColor;
        currentChart.options.scales.y.ticks.color = textColor;
        currentChart.options.scales.y.title.color = textColor;
        currentChart.options.scales.y.grid.color = gridColor;
        currentChart.options.plugins.title.color = textColor;
        currentChart.options.plugins.legend.labels.color = textColor;
        
        currentChart.update('none');
    }

    // Initialize theme on page load
    document.addEventListener('DOMContentLoaded', loadTheme);

    // Load stations from GeoJSON file
    fetch('stations.geojson')
        .then(response => response.json())
        .then(geojsonData => {
            // Extract stations that match our desired station IDs
            const desiredStationIds = new Set([400, 403, 420, 426, 433, 17444, 17445, 17446, 17447, 17448, 17449, 17450, 
                                              17451, 17452, 17453, 17454, 17455, 17456, 17457, 17458, 17459, 17460, 17461, 
                                              17462, 17463, 17464, 17465, 17466, 17467, 17468, 17469, 17470, 17471, 17472, 
                                              17473, 17474, 17475, 17476, 17477, 17478, 17479, 17480, 17481, 17482, 17483, 
                                              17484, 17485, 17486, 17487, 17488, 17489, 17490, 17491, 19897, 19898]);
            
            geojsonData.features.forEach(feature => {
                const stationId = parseInt(feature.properties.station_id);
                if (desiredStationIds.has(stationId)) {
                    STATIONS[stationId] = feature.properties.station_name;
                    STATION_FEATURES[stationId] = feature;
                }
            });
            
            populateStationDropdown();
            initializeMap();
        })
        .catch(error => {
            console.error('Error loading stations:', error);
            alert('Error loading station data');
        });

    function populateStationDropdown() {
        // Populate station dropdown, sorted alphabetically by name
        const stationSelect = document.getElementById('stationSelect');
        Object.entries(STATIONS)
            .sort((a, b) => a[1].localeCompare(b[1]))
            .forEach(([id, name]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                stationSelect.appendChild(option);
            });
        
        // Set default station after loading
        stationSelect.value = "19897";
        handleStationChange();
    }

    // Populate year dropdown (2020-2025)
    const yearSelect = document.getElementById('yearSelect');
    for (let year = 2020; year <= 2025; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }

    // Populate month dropdown
    const monthSelect = document.getElementById('monthSelect');
    const months = moment.months();
    months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index + 1; // 1-12 for January-December
        option.textContent = month;
        monthSelect.appendChild(option);
    });

    function initializeMap() {
        // Initialize map centered on Germany
        map = L.map('map').setView([51.1657, 10.4515], 6);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
    }

    function updateStationInfo(stationId) {
        const feature = STATION_FEATURES[stationId];
        if (!feature) return;
        
        const props = feature.properties;
        const coords = feature.geometry.coordinates;
        
        // Update station details
        document.getElementById('stationName').textContent = props.station_name;
        document.getElementById('stationId').textContent = props.station_id;
        document.getElementById('stationElevation').textContent = props.elevation || 'N/A';
        document.getElementById('stationState').textContent = props.federal_state || 'N/A';
        document.getElementById('stationCoords').textContent = `${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`;
        
        // Update map
        if (map) {
            // Remove previous marker
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            // Add new marker
            currentMarker = L.marker([coords[1], coords[0]])
                .addTo(map)
                .bindPopup(`<b>${props.station_name}</b><br>ID: ${props.station_id}<br>Elevation: ${props.elevation}m`);
            
            // Center map on station
            map.setView([coords[1], coords[0]], 10);
        }
        
        // Show station info section
        document.getElementById('stationInfo').classList.add('visible');
    }

    function handleStationChange() {
        const stationId = stationSelect.value;
        const dateSelectors = document.getElementById('dateSelectors');
        const stationInfo = document.getElementById('stationInfo');
        
        if (stationId) {
            // Set current year and month
            const now = moment();
            yearSelect.value = now.year();
            monthSelect.value = now.month() + 1; // moment months are 0-11, select uses 1-12
            dateSelectors.style.display = 'flex';
            updateStationInfo(stationId);
            loadStationData();
        } else {
            dateSelectors.style.display = 'none';
            stationInfo.classList.remove('visible');
            document.getElementById('charts').innerHTML = '';
        }
    }

    function changeMonth(direction) {
        const year = parseInt(yearSelect.value);
        const month = parseInt(monthSelect.value);
        if (!year || !month) return;

        let newDate = moment(`${year}-${month}-01`, 'YYYY-M-DD').add(direction, 'month');
        yearSelect.value = newDate.year();
        monthSelect.value = newDate.month() + 1; // moment months are 0-11, dropdown uses 1-12
        loadStationData();
    }

    function loadStationData() {
        const stationId = stationSelect.value;
        const year = yearSelect.value;
        const month = monthSelect.value;

        if (!stationId || !year || !month) {
            document.getElementById('charts').innerHTML = '';
            return;
        }

        const fileName = `data/rain_data_${stationId.padStart(5, '0')}.json`;
        fetch(fileName)
            .then(response => {
                if (!response.ok) {
                    throw new Error('File not found or network error');
                }
                return response.json();
            })
            .then(data => processData(data, STATIONS[stationId], year, month))
            .catch(error => {
                alert('Error loading data: ' + error.message);
                document.getElementById('charts').innerHTML = '';
            });
    }

    function processData(data, stationName, year, month) {
        if (!window.Chart) {
            alert('Chart.js is not available. Cannot render charts.');
            return;
        }

        // Destroy previous chart instance if it exists
        if (currentChart) {
            currentChart.destroy();
            currentChart = null;
        }

        // Filter data for the selected year and month
        const monthYear = `${year}-${month.padStart(2, '0')}`;
        const monthData = data
            .filter(entry => moment(entry.date, 'YYYY-MM-DD').format('YYYY-MM') === monthYear)
            .map(entry => ({
                date: moment(entry.date, 'YYYY-MM-DD').toDate(),
                precipitation: entry.precipitation
            }))
            .sort((a, b) => a.date - b.date);

        // Clear previous charts
        const chartsContainer = document.getElementById('charts');
        chartsContainer.innerHTML = '';

        if (monthData.length === 0) {
            chartsContainer.innerHTML = '<p>No data available for this month.</p>';
            return;
        }

        // Create a single bar chart for the selected month
        const container = document.createElement('div');
        container.className = 'chart-container';
        const canvas = document.createElement('canvas');
        container.appendChild(canvas);
        chartsContainer.appendChild(container);

        // Get theme colors
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const textColor = isDark ? '#e0e0e0' : '#333';
        const gridColor = isDark ? '#404040' : '#e0e0e0';

        currentChart = new Chart(canvas, {
            type: 'bar',
            data: {
                datasets: [{
                    label: `Precipitation (${stationName})`,
                    data: monthData.map(d => ({
                        x: d.date,
                        y: d.precipitation
                    })),
                    backgroundColor: 'rgba(0, 123, 255, 0.5)',
                    borderColor: '#007bff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 0
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'ddd MMM D' // Shows weekday, month, day
                            }
                        },
                        title: {
                            display: false,
                            text: 'Date',
                            color: textColor
                        },
                        min: moment(`${year}-${month}-01`, 'YYYY-MM-DD').toDate(),
                        max: moment(`${year}-${month}-01`, 'YYYY-MM-DD').endOf('month').toDate(),
                        ticks: {
                            maxRotation: 90,
                            minRotation: 90,
                            color: textColor
                        },
                        grid: {
                            color: gridColor
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Precipitation (mm)',
                            color: textColor
                        },
                        beginAtZero: true,
                        min: 0,
                        max: 60, // Set your desired max value
                        ticks: {
                            color: textColor
                        },
                        grid: {
                            color: gridColor
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: `Precipitation for ${stationName} - ${moment(monthYear, 'YYYY-MM').format('MMMM YYYY')}`,
                        color: textColor
                    },
                    legend: {
                        labels: {
                            color: textColor
                        }
                    }
                }
            }
        });

        // Force initial resize after a short delay
        setTimeout(() => {
            if (currentChart) {
                currentChart.resize();
            }
        }, 100);
    }

    function changeStation(direction) {
        const stationSelect = document.getElementById('stationSelect');
        const currentStationId = stationSelect.value;
        if (!currentStationId) return;

        // Get all station options (excluding the first empty option)
        const options = Array.from(stationSelect.options).slice(1);
        const currentIndex = options.findIndex(option => option.value === currentStationId);
        
        if (currentIndex === -1) return;

        // Calculate new index with wrapping
        let newIndex = currentIndex + direction;
        if (newIndex < 0) {
            newIndex = options.length - 1; // Wrap to last station
        } else if (newIndex >= options.length) {
            newIndex = 0; // Wrap to first station
        }

        // Store current year and month before changing station
        const currentYear = document.getElementById('yearSelect').value;
        const currentMonth = document.getElementById('monthSelect').value;

        // Change to new station
        stationSelect.value = options[newIndex].value;
        
        // Update station info
        updateStationInfo(options[newIndex].value);
        
        // Restore year and month, then load data
        if (currentYear && currentMonth) {
            document.getElementById('yearSelect').value = currentYear;
            document.getElementById('monthSelect').value = currentMonth;
        }
        
        loadStationData();
    }

    document.addEventListener('keydown', function (e) {
        // Only trigger if date selectors are visible
        const dateSelectors = document.getElementById('dateSelectors');
        if (dateSelectors.style.display !== 'flex') return;

        if (e.key === 'ArrowLeft') {
            changeMonth(-1);
            e.preventDefault();
        } else if (e.key === 'ArrowRight') {
            changeMonth(1);
            e.preventDefault();
        } else if (e.key === 'ArrowUp') {
            changeStation(-1); // Previous station
            e.preventDefault();
        } else if (e.key === 'ArrowDown') {
            changeStation(1); // Next station
            e.preventDefault();
        }
    });

    let currentChart = null;
    let touchStartX = null;
    let touchStartY = null;
    let resizeTimeout = null;

    // Debounced resize function
    function debounceResize() {
        if (resizeTimeout) {
            clearTimeout(resizeTimeout);
        }
        resizeTimeout = setTimeout(() => {
            if (currentChart) {
                currentChart.resize();
            }
        }, 150);
    }

    // Handle window resize to make chart responsive
    window.addEventListener('resize', debounceResize);

    document.addEventListener('touchstart', function (e) {
        if (e.touches.length === 1) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }
    });

    document.addEventListener('touchend', function (e) {
        if (touchStartX === null || touchStartY === null) return;
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const dx = touchEndX - touchStartX;
        const dy = touchEndY - touchStartY;

        // Only trigger if date selectors are visible
        const dateSelectors = document.getElementById('dateSelectors');
        if (dateSelectors.style.display !== 'flex') return;

        // Check for horizontal swipe (change months)
        if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
            if (dx < 0) {
                changeMonth(1); // Swipe left: next month
            } else {
                changeMonth(-1); // Swipe right: previous month
            }
        }
        // Check for vertical swipe (change stations)
        else if (Math.abs(dy) > 50 && Math.abs(dy) > Math.abs(dx)) {
            if (dy < 0) {
                changeStation(-1); // Swipe up: previous station
            } else {
                changeStation(1); // Swipe down: next station
            }
        }
        touchStartX = null;
        touchStartY = null;
    });
</script>
</body>
</html>